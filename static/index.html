<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Voice Stock Consultant — Minimal Test UI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:18px;background:#f6f7fb;color:#111}
    .box{max-width:900px;margin:auto}
    .card{background:#fff;padding:14px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:12px}
    textarea,input{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px}
    .row{display:flex;gap:8px;margin-top:8px}
    button{padding:8px 12px;border-radius:6px;border:0;background:#1f6feb;color:#fff;cursor:pointer}
    .secondary{background:#fff;color:#1f6feb;border:1px solid #cfe0ff}
    pre{background:#fafafa;padding:10px;border-radius:6px;border:1px solid #eee;overflow:auto}
    .muted{color:#666;font-size:13px}
  </style>
</head>
<body>
  <div class="box">
    <h2>Voice Stock Consultant — Minimal</h2>

    <div class="card">
      <label>Portfolio (JSON)</label>
      <textarea id="portfolio">{"name":"Demo","items":[{"ticker":"TCS","qty":2},{"ticker":"INFY","qty":3}]}</textarea>

      <label style="margin-top:8px">Question</label>
      <input id="question" placeholder="e.g., Should I reduce TCS?" />

      <div class="row">
        <button id="sendBtn">Send (text)</button>
        <button id="micBtn" class="secondary">Speak (Chrome)</button>
        <button id="demoA" class="secondary">Demo: Concentrated</button>
        <button id="demoB" class="secondary">Demo: Diversified</button>
      </div>

      <div style="margin-top:12px" id="result">Result will appear here.</div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Usage</strong></div>
        <div class="muted" id="usage">loading...</div>
      </div>

      <div style="margin-top:10px"><strong>Bills</strong></div>
      <div id="bills"><div class="muted">loading...</div></div>
    </div>

    <div class="muted" style="margin-top:8px">Notes: this page uses relative API routes like <code>/api/voice-query</code> and <code>/api/portfolio</code>.</div>
  </div>

<script>
const API_BASE = ''; // relative routes
const ADVICE_PRICE = 0.20;

const portfolioEl = document.getElementById('portfolio');
const questionEl = document.getElementById('question');
const resultEl = document.getElementById('result');
const usageEl = document.getElementById('usage');
const billsEl = document.getElementById('bills');

async function fetchUsage(){
  try{
    const res = await fetch(API_BASE + '/api/usage');
    const j = await res.json();
    usageEl.innerText = `Portfolios: ${j.portfolios_analyzed || 0} | Advices: ${j.advices_generated || 0}`;
  }catch(e){
    usageEl.innerText = 'error';
    console.log('usage err', e);
  }
}
async function fetchBills(){
  try{
    const res = await fetch(API_BASE + '/api/bills');
    const j = await res.json();
    if(!j || j.length===0){ billsEl.innerHTML = '<div class="muted">No bills yet</div>'; return; }
    let html = '<pre>' + JSON.stringify(j.slice(0,10), null, 2) + '</pre>';
    billsEl.innerHTML = html;
  }catch(e){
    billsEl.innerText = 'error loading bills';
    console.log('bills err', e);
  }
}

// POST /api/portfolio to create per-portfolio bill (and increment portfolios_analyzed)
async function createPortfolioOnServer(portfolio){
  try{
    const r = await fetch(API_BASE + '/api/portfolio', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(portfolio)
    });
    return r.ok;
  }catch(e){ console.log('create portfolio err', e); return false; }
}

// call voice-query (and create portfolio first)
async function sendQuery(){
  let portfolio;
  try{
    portfolio = JSON.parse(portfolioEl.value);
  }catch(e){
    alert('Portfolio JSON invalid. Use valid JSON.');
    return;
  }
  if(!Array.isArray(portfolio.items)){ alert('portfolio.items must be an array'); return; }
  // create portfolio record (per-portfolio billing)
  await createPortfolioOnServer({ name: portfolio.name || 'UserPortfolio', items: portfolio.items });

  // confirm billing for advice
  if(!confirm(`This will generate an advice and bill ₹${ADVICE_PRICE.toFixed(2)}. Proceed?`)) return;

  resultEl.innerText = 'Analyzing...';
  try{
    const res = await fetch(API_BASE + '/api/voice-query', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ portfolio: portfolio, question: questionEl.value || 'How is my portfolio?', voice: false })
    });
    if(!res.ok){
      const txt = await res.text();
      resultEl.innerText = 'Server error: ' + txt;
      return;
    }
    const j = await res.json();
    resultEl.innerHTML = `<div><strong>Advice:</strong> ${j.advice_text}</div><pre>${JSON.stringify(j.analysis, null, 2)}</pre><div><strong>Billed:</strong> ₹${j.billed.toFixed(2)}</div>`;
    // speak (if available)
    if('speechSynthesis' in window){ const u = new SpeechSynthesisUtterance(j.advice_text); window.speechSynthesis.speak(u); }
    await fetchUsage(); await fetchBills();
  }catch(e){
    resultEl.innerText = 'Network or server error (check console).';
    console.error(e);
  }
}

// Demo helpers (safe, no syntax mistakes)
document.getElementById('demoA').onclick = ()=> {
  portfolioEl.value = JSON.stringify({ name:'Concentrated', items:[ {ticker:'TCS', qty:10} ] }, null, 2);
  questionEl.value = 'Should I reduce TCS?';
};
document.getElementById('demoB').onclick = ()=> {
  portfolioEl.value = JSON.stringify({ name:'Diversified', items:[ {ticker:'TCS', qty:2}, {ticker:'HDFC', qty:2}, {ticker:'SUNPHARMA', qty:2} ] }, null, 2);
  questionEl.value = 'Is my portfolio balanced?';
};

document.getElementById('sendBtn').onclick = sendQuery;

// minimal voice support (Chrome)
document.getElementById('micBtn').onclick = async ()=>{
  if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)){ alert('Use Chrome for voice'); return; }
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const rec = new SpeechRecognition();
  rec.lang = 'en-US'; rec.interimResults = false; rec.maxAlternatives = 1;
  rec.onresult = (ev)=>{ questionEl.value = ev.results[0][0].transcript; sendQuery(); };
  rec.onerror = (e)=>{ alert('Speech error: ' + (e.error || 'unknown')); console.log(e); };
  rec.start();
};

// initial load
fetchUsage(); fetchBills();
</script>
</body>
</html>
